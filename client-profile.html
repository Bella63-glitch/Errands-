<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Profile - Run Me an Errand</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root { --maroon:#7B1E3A; --gold:#FFD700; --maroon-light: #922b4a; }
    .bg-maroon{background-color:var(--maroon);} 
    .text-maroon{color:var(--maroon);}
    .text-gold{color:var(--gold);} 
    .bg-gold{background-color:var(--gold);}
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--maroon);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .profile-card {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .initials-avatar {
      width: 5rem; height: 5rem;
      border-radius: 50%;
      border: 4px solid var(--gold);
      background: linear-gradient(135deg, var(--maroon) 0%, var(--maroon-light) 100%);
      color: var(--gold);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.75rem; font-weight: 800;
      box-shadow: 0 4px 10px rgba(123, 30, 58, 0.3);
    }

    /* Runner Card Styles */
    .runner-pill {
      min-width: 200px;
      transition: transform 0.2s;
    }
    .runner-pill:hover { transform: translateY(-5px); }
    
    /* Custom Scrollbar for recommendations */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12">

  <nav class="w-full bg-maroon p-4 text-gold flex justify-between items-center shadow-lg mb-8">
    <span class="font-black text-xl tracking-tighter uppercase">Run Me An Errand</span>
    <div class="space-x-4 flex items-center">
      <a href="index.html" class="text-sm font-bold hover:text-white transition">Home</a>
      <button id="logoutBtnTop" class="text-xs bg-gold text-maroon px-3 py-1 rounded font-bold uppercase">Logout</button>
    </div>
  </nav>

  <div id="profileContainer" class="max-w-5xl mx-auto px-4">
    
    <div id="profileContent">
        <div class="spinner"></div>
    </div>

    <div class="mt-12">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-maroon">Runners Near You</h3>
        <a href="runners.html" class="text-maroon font-bold text-sm hover:underline">View All <i class="fas fa-arrow-right ml-1"></i></a>
      </div>
      
      <div id="recommendationsList" class="flex space-x-4 overflow-x-auto pb-4 hide-scrollbar">
        <p class="text-gray-400 italic">Finding local runners...</p>
      </div>
    </div>

    <div id="statusMessage" class="mt-6 text-center font-bold"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://zchofpncqskvnfrzbcww.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjaG9mcG5jcXNrdm5mcnpiY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDI4NDIsImV4cCI6MjA3NTUxODg0Mn0.U-Zm4slsBcWHSpfhjM8jvBvtt8YCPMAiSopWR9-YXUI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const contentDiv = document.getElementById("profileContent");
    const statusMessage = document.getElementById("statusMessage");

    function getInitials(name, email) {
      if (name) {
        const parts = name.trim().split(/\s+/);
        if (parts.length > 1) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        return parts[0].substring(0, 2).toUpperCase();
      }
      return email ? email.substring(0, 2).toUpperCase() : "?";
    }

    async function loadProfile() {
      const email = localStorage.getItem('loggedInEmail');
      const userType = localStorage.getItem('userType');

      if (!email || userType !== "client") {
        window.location.href = "login.html";
        return;
      }

      try {
        const { data: user, error } = await supabase
          .from('users')
          .select('*')
          .eq('email', email)
          .maybeSingle();

        if (user) {
          renderProfile(user);
          loadRecommendations(user.location || "General");
        }
      } catch (err) {
        statusMessage.className = "text-red-500";
        statusMessage.textContent = "Error loading dashboard.";
      }
    }

    function renderProfile(user) {
      const initials = getInitials(user.full_name, user.email);
      contentDiv.innerHTML = `
        <div class="profile-card p-8">
          <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-8 mb-10 border-b pb-8">
            <div class="initials-avatar">${initials}</div>
            <div class="text-center md:text-left">
              <h2 class="text-4xl font-black text-maroon">${user.full_name || 'Valued Client'}</h2>
              <p class="text-gray-500 font-medium">${user.email}</p>
              <div class="mt-3 flex flex-wrap justify-center md:justify-start gap-2">
                <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest">Client Account</span>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest">Verified</span>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <div>
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-maroon uppercase tracking-wider">Account Details</h3>
                <button onclick='renderEditMode(${JSON.stringify(user)})' class="text-xs text-maroon font-bold hover:underline">Edit Info</button>
              </div>
              <div class="space-y-4">
                <div class="flex items-center space-x-3 text-gray-700">
                  <i class="fas fa-phone w-5 text-maroon"></i>
                  <span>${user.phone || 'No phone added'}</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                  <i class="fas fa-map-marker-alt w-5 text-maroon"></i>
                  <span>${user.location || 'Location not set'}</span>
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-bold text-maroon uppercase tracking-wider mb-4">Recent Activity</h3>
              <div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl p-6 text-center">
                <i class="fas fa-receipt text-slate-300 text-3xl mb-2"></i>
                <p class="text-sm text-slate-500">You haven't requested any errands yet.</p>
                <button onclick="window.location.href='runners.html'" class="mt-4 text-xs bg-maroon text-gold px-4 py-2 rounded-lg font-bold uppercase">Book First Errand</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.renderEditMode = function(user) {
      contentDiv.innerHTML = `
        <div class="profile-card p-8">
          <h2 class="text-2xl font-bold text-maroon mb-6">Update Profile</h2>
          <div class="space-y-6">
            <div>
              <label class="block text-xs font-bold text-maroon uppercase mb-1">Full Name</label>
              <input type="text" id="editName" value="${user.full_name || ''}" class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-maroon outline-none">
            </div>
            <div>
              <label class="block text-xs font-bold text-maroon uppercase mb-1">Phone Number</label>
              <input type="text" id="editPhone" value="${user.phone || ''}" class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-maroon outline-none">
            </div>
             <div>
              <label class="block text-xs font-bold text-maroon uppercase mb-1">Location (City/Area)</label>
              <input type="text" id="editLocation" value="${user.location || ''}" class="w-full border-2 border-slate-100 rounded-xl p-3 focus:border-maroon outline-none" placeholder="e.g. Nairobi, Kenya">
            </div>
            <div class="flex space-x-3">
              <button id="saveChanges" class="bg-maroon text-gold px-6 py-3 rounded-xl font-bold flex-1">Save Changes</button>
              <button onclick="loadProfile()" class="bg-slate-200 text-slate-600 px-6 py-3 rounded-xl font-bold">Cancel</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('saveChanges').addEventListener('click', async () => {
        const name = document.getElementById('editName').value;
        const phone = document.getElementById('editPhone').value;
        const location = document.getElementById('editLocation').value;

        const { error } = await supabase
          .from('users')
          .update({ full_name: name, phone: phone, location: location })
          .eq('email', user.email);

        if (!error) {
          statusMessage.innerHTML = "<span class='text-green-600'>Profile updated!</span>";
          setTimeout(() => { statusMessage.innerHTML = ""; loadProfile(); }, 1500);
        }
      });
    };

    async function loadRecommendations(userLocation) {
      const recList = document.getElementById("recommendationsList");
      
      try {
        // Fetching runners - prioritizing those in the same location
        let query = supabase.from('runners').select('*').eq('subscription_status', 'active');
        
        if (userLocation && userLocation !== "General") {
            // Try to find matches in the same city
            query = query.ilike('location', `%${userLocation}%`);
        }
        
        const { data: runners, error } = await query.limit(5);

        if (error || !runners || runners.length === 0) {
          recList.innerHTML = "<p class='text-gray-400 text-sm italic'>No local runners found right now. Check back later!</p>";
          return;
        }

        recList.innerHTML = runners.map(runner => `
          <div class="runner-pill bg-white border border-slate-200 p-4 rounded-2xl shadow-sm flex items-center space-x-4">
            <img src="${runner.profilepicture || 'https://via.placeholder.com/50'}" class="w-12 h-12 rounded-full object-cover border-2 border-gold">
            <div>
              <h4 class="font-bold text-maroon text-sm">${runner.name}</h4>
              <p class="text-[10px] text-gray-500 uppercase font-bold">${runner.location || 'Available'}</p>
              <div class="flex text-gold text-[10px] mt-1">
                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
              </div>
            </div>
          </div>
        `).join('');

      } catch (err) {
        recList.innerHTML = "";
      }
    }

    document.getElementById('logoutBtnTop').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    loadProfile();
  </script>
</body>
</html>











