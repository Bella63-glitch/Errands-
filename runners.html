<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>Run Me An Errand - Detailed Runners</title> 
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"> 
  <style>
        /* Custom CSS for colors */
        :root {
            --maroon: #7B1E3A;
            --gold: #FFD700;
            --light-gold: #FFEB80; /* A lighter shade for backgrounds */
        }
        .bg-maroon { background-color: var(--maroon); }
        .text-gold { color: var(--gold); }
        .bg-gold { background-color: var(--gold); }
        .border-gold { border-color: var(--gold); }
        .bg-light-gold { background-color: var(--light-gold); }

        /* Animation for runner cards */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-slide-up {
            animation: fadeInSlideUp 0.6s ease-out forwards;
        }

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--maroon);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Menu Styles */
        .mobile-menu {
            transition: max-height 0.3s ease-in-out;
            overflow: hidden;
            max-height: 0;
        }
        .mobile-menu.active {
            max-height: 500px; /* Sufficiently large to show all content */
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0; /* Changed from 30px to 0 for internal padding control */
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            position: relative;
            animation: fadeInScale 0.3s ease-out forwards;
            max-height: 90vh; /* Max height for modal content */
            overflow-y: auto; /* Enable scrolling within modal */
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 36px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
            z-index: 1010; /* Ensure it's above modal header */
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--maroon);
            text-decoration: none;
            cursor: pointer;
        }

        /* Skeleton loader for cards */
        .skeleton {
            background-color: #e2e8f0; /* bg-gray-200 */
            border-radius: 8px;
            animation: pulse 1.5s infinite ease-in-out;
        }

        .skeleton-circle {
            width: 96px; /* w-24 */
            height: 96px; /* h-24 */
            border-radius: 50%;
        }

        .skeleton-text {
            height: 1em;
            width: 80%;
            margin-bottom: 0.5em;
        }
        .skeleton-text.long {
            width: 90%;
        }
        .skeleton-text.short {
            width: 60%;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style> 
 </head> 
 <body class="bg-gray-50 text-gray-800 font-sans"> 
  <header class="bg-maroon shadow-md sticky top-0 z-50"> 
   <div class="max-w-7xl mx-auto flex justify-between items-center py-5 px-6"> <a href="index.html" class="flex items-center space-x-2"> <img src="https://img.icons8.com/fluent/48/ffffff/running.png" alt="Errand Logo"> <h1 class="text-2xl font-bold text-white transition-colors duration-300 hover:text-gold">Run Me An Errand</h1> </a> 
    <nav class="hidden md:flex space-x-6 text-lg"> <a href="index.html" class="text-gray-300 hover:text-gold transition-colors duration-300">Home</a> <a href="index.html#how-it-works" class="text-gray-300 hover:text-gold transition-colors duration-300">How It Works</a> <a href="index.html#why-choose-us" class="text-gray-300 hover:text-gold transition-colors duration-300">Why Choose Us</a> <a href="index.html#testimonials" class="text-gray-300 hover:text-gold transition-colors duration-300">Reviews</a> <a href="index.html#contact" class="text-gray-300 hover:text-gold transition-colors duration-300">Contact</a> <a href="#" class="text-gray-300 hover:text-gold transition-colors duration-300">Become a Runner</a> 
    </nav> 
    <div class="hidden md:flex space-x-4"> <a href="#" class="bg-gold text-maroon px-4 py-2 rounded-full hover:bg-white hover:text-maroon transition duration-300">Login</a> <a href="#" class="bg-white text-maroon px-4 py-2 rounded-full hover:bg-gold hover:text-maroon transition duration-300">Sign Up</a> 
    </div> 
    <div class="md:hidden"> <button id="mobile-menu-button" class="text-gray-300 hover:text-gold focus:outline-none focus:ring-2 focus:ring-gold"> 
      <svg class="h-6 w-6 fill-current" viewbox="0 0 24 24"> <path fill-rule="evenodd" clip-rule="evenodd" d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h16v2H4v-2z"></path> 
      </svg></button> 
    </div> 
   </div> 
   <nav id="mobile-menu" class="mobile-menu md:hidden bg-maroon pb-4"> <a href="index.html" class="block px-6 py-2 text-white hover:bg-maroon-dark hover:text-gold transition-colors duration-300">Home</a> <a href="index.html#how-it-works" class="block px-6 py-2 text-white hover:bg-maroon-dark hover:text-gold transition-colors duration-300">How It Works</a> <a href="index.html#why-choose-us" class="block px-6 py-2 text-white hover:bg-maroon-dark hover:text-gold transition-colors duration-300">Why Choose Us</a> <a href="index.html#testimonials" class="block px-6 py-2 text-white hover:bg-maroon-dark hover:text-gold transition-colors duration-300">Reviews</a> <a href="index.html#contact" class="block px-6 py-2 text-white hover:bg-maroon-dark hover:text-gold transition-colors duration-300">Contact</a> <a href="#" class="block px-6 py-2 text-white hover:bg-maroon-dark hover:text-gold transition-colors duration-300">Become a Runner</a> 
    <div class="px-6 pt-4 flex flex-col space-y-3"> <a href="#" class="bg-gold text-maroon px-4 py-2 rounded-full text-center hover:bg-white hover:text-maroon transition duration-300">Login</a> <a href="#" class="bg-white text-maroon px-4 py-2 rounded-full text-center hover:bg-gold hover:text-maroon transition duration-300">Sign Up</a> 
    </div> 
   </nav> 
  </header> 
  <main class="py-12 px-6"> 
   <div class="max-w-7xl mx-auto"> 
    <h2 class="text-4xl font-extrabold text-maroon text-center mb-4">Discover Your Ideal Runner</h2> 
    <p class="text-xl text-gray-700 text-center mb-10">Browse through our trusted runners, filter by your needs, and book with confidence.</p> 
    <div class="bg-white p-6 rounded-lg shadow-md mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"> 
     <div> <label for="location-select" class="block text-sm font-medium text-gray-700 mb-2">Your Location:</label> <select id="location-select" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon focus:border-maroon"> <option value="auto">Auto-detect my location</option> <option value="nairobi-cbd">Nairobi CBD</option> <option value="kilimani">Kilimani, Nairobi</option> <option value="westlands">Westlands, Nairobi</option> <option value="embakasi">Embakasi, Nairobi</option> <option value="lavington">Lavington, Nairobi</option> <option value="kisumu">Kisumu CBD</option> <option value="eldoret">Eldoret Town</option> <option value="mombasa">Mombasa Island</option> <option value="nakuru">Nakuru Town</option> <option value="remote">Remote Area</option> </select> 
     </div> 
     <div> <label for="service-filter" class="block text-sm font-medium text-gray-700 mb-2">Service Type:</label> <select id="service-filter" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon focus:border-maroon"> <option value="all">All Services</option> <option value="Grocery">Grocery Delivery</option> <option value="Parcel">Parcel Delivery</option> <option value="Pharmacy">Pharmacy Run</option> <option value="Document">Document Delivery</option> <option value="Bill Payments">Bill Payments</option> <option value="Laundry">Laundry Service</option> <option value="Queueing">Queueing Service</option> <option value="Mobile Money Transfer">Mobile Money</option> <option value="Home Services">Home Services (Plumbing/Electrician)</option> <option value="Personal Shopper">Personal Shopper</option> </select> 
     </div> 
     <div> <label for="availability-filter" class="block text-sm font-medium text-gray-700 mb-2">Availability:</label> <select id="availability-filter" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon focus:border-maroon"> <option value="all">All</option> <option value="Available">Available Now</option> </select> 
     </div> 
     <div> <label for="sort-by" class="block text-sm font-medium text-gray-700 mb-2">Sort By:</label> <select id="sort-by" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-maroon focus:border-maroon"> <option value="distance">Distance (Closest First)</option> <option value="rating">Rating (Highest First)</option> <option value="tasksCompleted">Tasks Completed (Most First)</option> </select> 
     </div> 
     <div class="md:col-span-2 lg:col-span-4 text-center"> <button id="apply-filters" class="w-full md:w-auto bg-maroon text-white px-8 py-3 rounded-md hover:bg-gold hover:text-maroon transition duration-300 font-semibold shadow-lg">Apply Filters & Find Runners</button> 
     </div> 
    </div> 
    <div id="status-container" class="mb-8 min-h-[80px] flex items-center justify-center"> 
     <div id="location-status" class="text-center p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 rounded-lg hidden"> 
      <div class="flex items-center justify-center space-x-3"> 
       <div class="loader"></div> 
       <p class="text-lg font-semibold">Detecting your location...</p> 
      </div> 
     </div> 
     <div id="location-error" class="text-center p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg hidden"> 
      <p class="text-lg font-semibold mb-2">Location access denied or unavailable.</p> 
      <p class="text-md">Please enable location services or select a manual location.</p> <button id="retry-location" class="mt-4 bg-maroon text-white px-6 py-2 rounded-full hover:bg-gold hover:text-maroon transition duration-300">Try Auto-Detect Again</button> 
     </div> 
     <div id="no-runners-found" class="text-center p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-lg hidden"> 
      <p class="text-lg font-semibold mb-2">No runners match your criteria near this location.</p> 
      <p class="text-md">Try adjusting your filters or selecting a different location. Displaying all runners as fallback.</p> 
     </div>
     <div id="fetch-error" class="text-center p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg hidden">
         <p class="text-lg font-semibold mb-2">Failed to load runners data.</p>
         <p class="text-md">There was a problem connecting to the server. Please try again later.</p>
     </div>
    </div> 
    <div id="runners-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"> 
     <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200"> 
      <div class="skeleton-circle mb-4 skeleton"></div> 
      <div class="skeleton-text long skeleton"></div> 
      <div class="skeleton-text short skeleton"></div> 
      <div class="skeleton-text skeleton w-full mt-3"></div> 
      <div class="skeleton-text skeleton w-1/2 mt-2"></div> 
      <div class="skeleton-text skeleton w-full h-8 mt-4"></div> 
     </div> 
     <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200"> 
      <div class="skeleton-circle mb-4 skeleton"></div> 
      <div class="skeleton-text long skeleton"></div> 
      <div class="skeleton-text short skeleton"></div> 
      <div class="skeleton-text skeleton w-full mt-3"></div> 
      <div class="skeleton-text skeleton w-1/2 mt-2"></div> 
      <div class="skeleton-text skeleton w-full h-8 mt-4"></div> 
     </div> 
     <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200 hidden lg:flex"> 
      <div class="skeleton-circle mb-4 skeleton"></div> 
      <div class="skeleton-text long skeleton"></div> 
      <div class="skeleton-text short skeleton"></div> 
      <div class="skeleton-text skeleton w-full mt-3"></div> 
      <div class="skeleton-text skeleton w-1/2 mt-2"></div> 
      <div class="skeleton-text skeleton w-full h-8 mt-4"></div> 
     </div> 
     <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200 hidden xl:flex"> 
      <div class="skeleton-circle mb-4 skeleton"></div> 
      <div class="skeleton-text long skeleton"></div> 
      <div class="skeleton-text short skeleton"></div> 
      <div class="skeleton-text skeleton w-full mt-3"></div> 
      <div class="skeleton-text skeleton w-1/2 mt-2"></div> 
      <div class="skeleton-text skeleton w-full h-8 mt-4"></div> 
     </div> 
    </div> 
   </div> 
  </main> 
  <div id="runner-modal" class="modal"> 
   <div class="modal-content"> <span class="close-button">×</span> 
    <div id="modal-content-area"> 
     <div class="bg-maroon text-white p-6 rounded-t-lg text-center relative overflow-hidden"> 
      <img id="modal-runner-photo" src="" alt="Runner Photo" class="w-32 h-32 rounded-full object-cover mx-auto mb-4 border-4 border-gold shadow-lg transform translate-y-8 relative z-10"> 
      <div class="pt-8 pb-4"> 
       <h3 id="modal-runner-name" class="text-3xl font-extrabold mb-1"></h3> 
       <div class="flex items-center justify-center mb-2"> 
        <div id="modal-runner-rating-stars" class="flex"> 
        </div> <span id="modal-runner-rating-value" class="font-semibold ml-2"></span> <span id="modal-runner-tasks" class="text-gray-300 text-sm ml-2"></span> 
       </div> 
       <p id="modal-runner-availability" class="text-md font-bold px-4 py-1 rounded-full inline-block mt-2"></p> 
      </div> 
     </div> 
     <div class="bg-white p-6 pb-2 grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8 -mt-8 relative z-0 rounded-b-lg"> 
      <div> 
       <h4 class="text-xl font-bold text-maroon mb-3 border-b pb-2 border-gray-200">About <span id="modal-about-runner-name"></span></h4> 
       <p id="modal-runner-bio" class="text-gray-700 leading-relaxed text-sm"></p> 
      </div> 
      <div> 
       <h4 class="text-xl font-bold text-maroon mb-3 border-b pb-2 border-gray-200">Services Offered</h4> 
       <div id="modal-runner-services" class="flex flex-wrap gap-2"></div> 
      </div> 
      <div> 
       <h4 class="text-xl font-bold text-maroon mb-3 border-b pb-2 border-gray-200">Key Details</h4> 
       <ul class="space-y-2 text-gray-700 text-sm"> 
        <li><strong class="text-maroon">Current Location:</strong> <span id="modal-runner-location"></span></li> 
        <li><strong class="text-maroon">Hourly Rate:</strong> <span id="modal-runner-rate"></span></li> 
        <li><strong class="text-maroon">Vehicle Type:</strong> <span id="modal-runner-vehicle"></span></li> 
        <li><strong class="text-maroon">Avg. Response Time:</strong> <span id="modal-runner-response-time"></span></li> 
        <li><strong class="text-maroon">Languages Spoken:</strong> <span id="modal-runner-languages"></span></li> 
       </ul> <a id="modal-runner-map-link" href="#" target="_blank" class="text-blue-600 hover:underline text-sm mt-4 flex items-center"> 
        <svg class="w-4 h-4 mr-1" fill="currentColor" viewbox="0 0 20 20">
         <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
        </svg> View Runner's Base on Map </a> 
      </div> 
      <div> 
       <h4 class="text-xl font-bold text-maroon mb-3 border-b pb-2 border-gray-200">Recent Reviews</h4> 
       <div id="modal-runner-reviews" class="space-y-4 text-sm"> 
       </div> 
      </div> 
     </div> 
     <div class="bg-gray-50 p-6 pt-4 text-center rounded-b-lg border-t border-gray-200"> <button id="modal-book-now-btn" class="bg-gold text-maroon px-8 py-3 rounded-full font-bold text-lg hover:bg-maroon hover:text-white transition duration-300 shadow-xl w-full md:w-2/3">Book This Runner Now</button> 
      <p class="text-gray-600 text-xs mt-3">We'll connect you directly to discuss your errand.</p> 
     </div> 
    </div> 
   </div> 
  </div> 
  <footer class="bg-gray-800 text-gray-300 py-12"> 
   <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-3 gap-8"> 
    <div> 
     <h4 class="text-lg font-bold text-gold mb-4">Run Me An Errand</h4> 
     <p class="text-sm mb-2">Your reliable partner for errand services across Kenya.</p> 
     <p class="text-sm">© 2025 Run Me An Errand. All rights reserved.</p> 
    </div> 
    <div> 
     <h4 class="text-lg font-bold text-gold mb-4">Quick Links</h4> 
     <ul class="space-y-2 text-sm"> 
      <li><a href="index.html" class="hover:text-gold transition-colors duration-200">Home</a></li> 
      <li><a href="#" class="hover:text-gold transition-colors duration-200">Services</a></li> 
      <li><a href="index.html#how-it-works" class="hover:text-gold transition-colors duration-200">How It Works</a></li> 
      <li><a href="index.html#why-choose-us" class="hover:text-gold transition-colors duration-200">Why Choose Us</a></li> 
      <li><a href="index.html#testimonials" class="hover:text-gold transition-colors duration-200">Reviews</a></li> 
      <li><a href="index.html#contact" class="hover:text-gold transition-colors duration-200">Contact Us</a></li> 
      <li><a href="#" class="hover:text-gold transition-colors duration-200">Become a Runner</a></li> 
      <li><a href="#" class="hover:text-gold transition-colors duration-200">FAQ</a></li> 
      <li><a href="#" class="hover:text-gold transition-colors duration-200">Privacy Policy</a></li> 
      <li><a href="#" class="hover:text-gold transition-colors duration-200">Terms of Service</a></li> 
     </ul> 
    </div> 
    <div> 
     <h4 class="text-lg font-bold text-gold mb-4">Contact Info</h4> 
     <p class="text-sm mb-2">Email: <a href="mailto:support@runerrand.co.ke" class="hover:text-gold">support@runerrand.co.ke</a></p> 
     <p class="text-sm mb-2">Phone: <a href="tel:+254712345678" class="hover:text-gold">+254 712 345 678</a></p> 
     <div class="flex space-x-4 mt-4"> <a href="#" class="text-gray-300 hover:text-gold" aria-label="Twitter"> 
       <svg class="h-5 w-5 fill-current" viewbox="0 0 24 24"> <path fill="currentColor" d="M22.46 6c-.77.67-1.72 1.13-2.77 1.33a4.76 4.76 0 002.07-2.62c-.82.48-1.75.83-2.79 1.02a4.78 4.78 0 00-8.13 4.3A13.54 13.54 0 013.57 4.3c.83 1.42 2.08 2.4 3.57 3.07a4.78 4.78 0 00-2.22-.61c.3-.08.59-.12.88-.12a4.78 4.78 0 004.46 3.31 9.5 9.5 0 01-5.78 1.98c-.34-.1-.68-.16-1.02-.18a4.75 4.75 0 004.88 3.3 9.5 9.5 0 01-7.64 3.27c-.36-.02-.72-.03-1.08-.03a13.57 13.57 0 006.94 2.16c4.16 0 7.67-3.46 7.67-7.67 0-.12 0-.23-.34-.69a4.66 4.66 0 001.53-1.3"></path> 
       </svg></a> <a href="#" class="text-gray-300 hover:text-gold" aria-label="Facebook"> 
       <svg class="h-5 w-5 fill-current" viewbox="0 0 24 24"> <path fill="currentColor" d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.88V15H8v-3h2V9.5c0-2.17 1.34-3.34 3.27-3.34 1.83 0 2.93 1.5 2.93 3.34V12h2v3h-2v6.88c4.56-1.01 8-5.04 8-9.88z"></path> 
       </svg></a> <a href="#" class="text-gray-300 hover:text-gold" aria-label="Instagram"> 
       <svg class="h-5 w-5 fill-current" viewbox="0 0 24 24"> <path fill="currentColor" d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.148 3.252-1.691-4.771-4.919-4.919.058-1.265-.069-1.644-.069-4.849 0-3.205.012-3.584.069-4.849.148-3.252 1.691-4.771 4.919-4.919 1.265-.058 1.644-.07 4.849-.07zM12 6.893c-2.857 0-5.146 2.289-5.146 5.146 0 2.857 2.289 5.146 5.146 5.146 2.857 0 5.146-2.289 5.146-5.146 0-2.857-2.289-5.146-5.146-5.146zm0 8.469c-1.827 0-3.333-1.506-3.333-3.333 0-1.827 1.506-3.333 3.333-3.333 1.827 0 3.333 1.506 3.333 3.333 0 1.827-1.506 3.333-3.333 3.333z"></path> <path fill-rule="evenodd" clip-rule="evenodd" d="M12 3.998c-4.414 0-8 3.586-8 8 0 4.414 3.586 8 8 8 4.414 0 8-3.586 8-8 0-4.414-3.586-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-3.31 2.69-6 6-6 3.31 0 6 2.69 6 6 0 3.31-2.69 6-6 6z"></path> 
       </svg></a> 
     </div> 
    </div> 
   </div> 
  </footer> <button id="back-to-top" class="fixed bottom-6 right-6 bg-maroon text-white p-3 rounded-full shadow-lg hover:bg-gold hover:text-maroon transition duration-300 hidden"> 
   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
   </svg> </button> 
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Backendless Credentials ---
        const APP_ID = "9223CBD1-9AFC-4C74-B56B-12F11D319DF9";
        const API_KEY = "0C3700EB-013B-4BFE-85ED-CE0F6F7EC013";
        let runnersData = [];

        // --- DOM Elements ---
        const statusContainer = document.getElementById('status-container');
        const locationStatusDiv = document.getElementById('location-status');
        const runnersListDiv = document.getElementById('runners-list');
        const locationErrorDiv = document.getElementById('location-error');
        const noRunnersFoundDiv = document.getElementById('no-runners-found');
        const fetchErrorDiv = document.getElementById('fetch-error'); // New fetch error element
        const retryLocationButton = document.getElementById('retry-location');
        const locationSelect = document.getElementById('location-select');
        const serviceFilter = document.getElementById('service-filter');
        const availabilityFilter = document.getElementById('availability-filter');
        const sortBy = document.getElementById('sort-by');
        const applyFiltersButton = document.getElementById('apply-filters');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const backToTopButton = document.getElementById('back-to-top');

        // Modal Elements
        const runnerModal = document.getElementById('runner-modal');
        const closeModalButton = document.querySelector('.close-button');
        const modalRunnerPhoto = document.getElementById('modal-runner-photo');
        const modalRunnerName = document.getElementById('modal-runner-name');
        const modalAboutRunnerName = document.getElementById('modal-about-runner-name');
        const modalRunnerRatingStars = document.getElementById('modal-runner-rating-stars');
        const modalRunnerRatingValue = document.getElementById('modal-runner-rating-value');
        const modalRunnerTasks = document.getElementById('modal-runner-tasks');
        const modalRunnerAvailability = document.getElementById('modal-runner-availability');
        const modalRunnerLocation = document.getElementById('modal-runner-location');
        const modalRunnerMapLink = document.getElementById('modal-runner-map-link');
        const modalRunnerBio = document.getElementById('modal-runner-bio');
        const modalRunnerServices = document.getElementById('modal-runner-services');
        const modalRunnerRate = document.getElementById('modal-runner-rate');
        const modalRunnerVehicle = document.getElementById('modal-runner-vehicle');
        const modalRunnerResponseTime = document.getElementById('modal-runner-response-time');
        const modalRunnerLanguages = document.getElementById('modal-runner-languages');
        const modalRunnerReviews = document.getElementById('modal-runner-reviews');
        const modalBookNowBtn = document.getElementById('modal-book-now-btn');

        // --- Global State ---
        let currentUserLocation = null;

        // --- Simulated User Locations for Manual Override ---
        const simulatedLocations = {
            "nairobi-cbd": { latitude: -1.286389, longitude: 36.817223, name: "Nairobi CBD" },
            "kilimani": { latitude: -1.292066, longitude: 36.821946, name: "Kilimani, Nairobi" },
            "westlands": { latitude: -1.267600, longitude: 36.790400, name: "Westlands, Nairobi" },
            "embakasi": { latitude: -1.309000, longitude: 36.888700, name: "Embakasi, Nairobi" },
            "lavington": { latitude: -1.283300, longitude: 36.750000, name: "Lavington, Nairobi" },
            "kisumu": { latitude: -0.0917, longitude: 34.7679, name: "Kisumu CBD" },
            "eldoret": { latitude: 0.5218, longitude: 35.2690, name: "Eldoret Town" },
            "mombasa": { latitude: -4.0357, longitude: 39.6682, name: "Mombasa Island" },
            "nakuru": { latitude: -0.2831, longitude: 36.0772, name: "Nakuru Town" },
            "remote": { latitude: -1.0, longitude: 40.0, name: "a remote area" }
        };

        // --- Haversine Formula for Distance Calculation ---
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c;
            return d;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Helper: Generate Star HTML ---
        function generateStarRating(rating) {
            let starsHtml = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                starsHtml += '<svg class="w-5 h-5 text-gold fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>';
            }
            if (hasHalfStar) {
                starsHtml += '<svg class="w-5 h-5 text-gold fill-current" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>';
            }
            return starsHtml;
        }

        // --- Display Runners Function ---
        function displayRunners(runnersToDisplay) {
            runnersListDiv.innerHTML = '';
            runnersListDiv.classList.remove('hidden');

            if (runnersToDisplay.length === 0) {
                setStatusMessage('no_runners');
                runnersListDiv.classList.add('hidden');
                return;
            } else {
                statusContainer.innerHTML = '';
            }

            runnersToDisplay.forEach((runner, index) => {
                const runnerCard = document.createElement('div');
                runnerCard.className = `bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 cursor-pointer animate-fade-in-slide-up`;
                runnerCard.style.animationDelay = `${index * 0.1}s`;
                runnerCard.dataset.runnerId = runner.objectId;

                let distanceInfo = '';
                if (currentUserLocation && currentUserLocation.latitude && runner.location && runner.location.latitude) {
                    const distance = getDistanceFromLatLonInKm(
                        currentUserLocation.latitude, currentUserLocation.longitude,
                        runner.location.latitude, runner.location.longitude
                    );
                    distanceInfo = `<p class="text-sm text-gray-500 mt-2">~${distance.toFixed(1)} km from you</p>`;
                } else if (runner.location && runner.location.area) {
                     distanceInfo = `<p class="text-sm text-gray-500 mt-2">Based in ${runner.location.area}</p>`;
                } else {
                    distanceInfo = `<p class="text-sm text-gray-500 mt-2">Location not specified</p>`;
                }

                const availabilityClass = runner.availability === 'Available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';

                const photoPath = runner.photoFilename ? `profiles/${runner.photoFilename}` : 'https://via.placeholder.com/96';

                runnerCard.innerHTML = `
                    <img src="${photoPath}" alt="${runner.name}" class="w-24 h-24 rounded-full object-cover mb-4 border-2 border-gold shadow-md">
                    <h3 class="text-xl font-bold text-maroon mb-1">${runner.name}</h3>
                    <div class="flex items-center justify-center mb-2">
                        ${generateStarRating(runner.rating || 0)}
                        <span class="text-gray-700 font-medium ml-1">${(runner.rating || 0).toFixed(1)}</span>
                        <span class="text-gray-500 text-sm ml-2">(${runner.tasksCompleted || 0} tasks)</span>
                    </div>
                    ${distanceInfo}
                    <p class="text-xs font-semibold ${availabilityClass} px-3 py-1 rounded-full mt-2">${runner.availability || 'Unknown'}</p>
                    <p class="text-sm text-gray-600 italic mt-3 mb-4 line-clamp-3">${runner.bio || 'This runner has not provided a bio yet.'}</p>
                    <div class="flex flex-wrap justify-center gap-2 mb-4">
                        ${(runner.services || []).slice(0, 3).map(service => `<span class="bg-gray-200 text-gray-700 text-xs px-3 py-1 rounded-full">${service}</span>`).join('')}
                        ${(runner.services || []).length > 3 ? `<span class="bg-gray-200 text-gray-700 text-xs px-3 py-1 rounded-full">+${runner.services.length - 3} more</span>` : ''}
                    </div>
                    <button class="bg-gold text-maroon px-5 py-2 rounded-full font-semibold hover:bg-maroon hover:text-white transition duration-300 shadow mt-auto w-full view-profile-btn" data-runner-id="${runner.objectId}">View Profile</button>
                `;
                runnersListDiv.appendChild(runnerCard);
            });

            document.querySelectorAll('.view-profile-btn, .animate-fade-in-slide-up').forEach(element => {
                element.addEventListener('click', (event) => {
                    const runnerId = event.currentTarget.dataset.runnerId;
                    openRunnerModal(runnerId);
                });
            });
        }
        
        // --- Backendless API Call ---
        async function fetchRunnersData() {
            setStatusMessage('loading', 'Fetching runners from the server...');
            try {
                const url = `https://api.backendless.com/${APP_ID}/${API_KEY}/data/users?where=role%3D'runner'`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                runnersData = data;
                
                // Now that we have data, initialize location and apply filters
                initializeLocationAndRunners();
            } catch (error) {
                console.error("Failed to fetch runners:", error);
                setStatusMessage('fetch_error');
            }
        }


        // --- Filter and Sort Logic ---
        function applyFiltersAndSort() {
            let filteredRunners = [...runnersData];

            // 1. Filter by Service Type
            const selectedService = serviceFilter.value;
            if (selectedService !== 'all') {
                filteredRunners = filteredRunners.filter(runner => runner.services && runner.services.includes(selectedService));
            }

            // 2. Filter by Availability
            const selectedAvailability = availabilityFilter.value;
            if (selectedAvailability === 'Available') {
                filteredRunners = filteredRunners.filter(runner => runner.availability === 'Available');
            }

            // 3. Filter by Location (proximity)
            const maxDistanceKm = 50;
            let runnersByLocation = [];

            if (currentUserLocation && currentUserLocation.latitude) {
                runnersByLocation = filteredRunners.filter(runner => {
                    if (runner.location && runner.location.latitude && runner.location.longitude) {
                        const distance = getDistanceFromLatLonInKm(
                            currentUserLocation.latitude, currentUserLocation.longitude,
                            runner.location.latitude, runner.location.longitude
                        );
                        runner.distance = distance;
                        return distance <= maxDistanceKm;
                    }
                    return false;
                });
            } else {
                runnersByLocation = filteredRunners.map(runner => {
                    runner.distance = Infinity;
                    return runner;
                });
            }

            let finalRunnersToDisplay = runnersByLocation;
            if (runnersByLocation.length === 0 && (selectedService !== 'all' || selectedAvailability !== 'all')) {
                setStatusMessage('no_runners');
                 finalRunnersToDisplay = filteredRunners.map(runner => {
                    runner.distance = Infinity;
                    return runner;
                });
            } else if (runnersByLocation.length === 0) {
                 setStatusMessage('no_runners');
                finalRunnersToDisplay = runnersData.map(runner => {
                    runner.distance = Infinity;
                    return runner;
                });
            } else {
                setStatusMessage('success');
            }

            // 4. Sort
            const selectedSort = sortBy.value;
            finalRunnersToDisplay.sort((a, b) => {
                if (selectedSort === 'distance') {
                    return a.distance - b.distance;
                } else if (selectedSort === 'rating') {
                    return (b.rating || 0) - (a.rating || 0);
                } else if (selectedSort === 'tasksCompleted') {
                    return (b.tasksCompleted || 0) - (a.tasksCompleted || 0);
                }
                return 0;
            });

            setTimeout(() => {
                displayRunners(finalRunnersToDisplay);
            }, 700);
        }

        // --- Location Handling Functions ---
        function setStatusMessage(type, message = null) {
            locationStatusDiv.classList.add('hidden');
            locationErrorDiv.classList.add('hidden');
            noRunnersFoundDiv.classList.add('hidden');
            fetchErrorDiv.classList.add('hidden');
            runnersListDiv.innerHTML = '';
            runnersListDiv.classList.remove('hidden');

            if (type === 'loading') {
                locationStatusDiv.classList.remove('hidden');
                locationStatusDiv.innerHTML = `<div class="flex items-center justify-center space-x-3"><div class="loader"></div><p class="text-lg font-semibold">${message || 'Detecting your location...'}</p></div>`;
                runnersListDiv.innerHTML = `
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200"><div class="skeleton-circle mb-4 skeleton"></div><div class="skeleton-text long skeleton"></div><div class="skeleton-text short skeleton"></div><div class="skeleton-text skeleton w-full mt-3"></div><div class="skeleton-text skeleton w-1/2 mt-2"></div><div class="skeleton-text skeleton w-full h-8 mt-4"></div></div>
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200"><div class="skeleton-circle mb-4 skeleton"></div><div class="skeleton-text long skeleton"></div><div class="skeleton-text short skeleton"></div><div class="skeleton-text skeleton w-full mt-3"></div><div class="skeleton-text skeleton w-1/2 mt-2"></div><div class="skeleton-text skeleton w-full h-8 mt-4"></div></div>
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200 hidden lg:flex"><div class="skeleton-circle mb-4 skeleton"></div><div class="skeleton-text long skeleton"></div><div class="skeleton-text short skeleton"></div><div class="skeleton-text skeleton w-full mt-3"></div><div class="skeleton-text skeleton w-1/2 mt-2"></div><div class="skeleton-text skeleton w-full h-8 mt-4"></div></div>
                    <div class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center text-center border border-gray-200 hidden xl:flex"><div class="skeleton-circle mb-4 skeleton"></div><div class="skeleton-text long skeleton"></div><div class="skeleton-text short skeleton"></div><div class="skeleton-text skeleton w-full mt-3"></div><div class="skeleton-text skeleton w-1/2 mt-2"></div><div class="skeleton-text skeleton w-full h-8 mt-4"></div></div>
                `;
            } else if (type === 'error') {
                locationErrorDiv.classList.remove('hidden');
                if (message) locationErrorDiv.querySelector('p:first-child').textContent = message;
            } else if (type === 'no_runners') {
                noRunnersFoundDiv.classList.remove('hidden');
            } else if (type === 'fetch_error') {
                fetchErrorDiv.classList.remove('hidden');
            } else if (type === 'success') {
                statusContainer.innerHTML = '';
            }
        }

        function getBrowserLocation() {
            setStatusMessage('loading', 'Detecting your precise location...');
            locationSelect.value = 'auto';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentUserLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            name: "Your current location"
                        };
                        localStorage.setItem('simulatedLocation', 'auto');
                        setStatusMessage('success');
                        applyFiltersAndSort();
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        let errorMessage = "Location access denied or unavailable.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "You denied location access. Please enable it in browser settings or select a location manually.";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = "Your location could not be determined. Please try again or select manually.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Location detection timed out. Please try again or select manually.";
                        }
                        setStatusMessage('error', errorMessage);
                        currentUserLocation = null;
                        localStorage.setItem('simulatedLocation', 'auto');
                        applyFiltersAndSort();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            } else {
                setStatusMessage('error', "Geolocation is not supported by your browser. Please use a modern browser or select a location manually.");
                currentUserLocation = null;
                localStorage.setItem('simulatedLocation', 'auto');
                applyFiltersAndSort();
            }
        }

        function initializeLocationAndRunners() {
            const storedLocationKey = localStorage.getItem('simulatedLocation');
            if (storedLocationKey && storedLocationKey !== 'auto' && simulatedLocations[storedLocationKey]) {
                locationSelect.value = storedLocationKey;
                currentUserLocation = simulatedLocations[storedLocationKey];
                setStatusMessage('success');
                applyFiltersAndSort();
            } else {
                getBrowserLocation();
            }
        }

        // --- Modal Functions ---
        function openRunnerModal(runnerId) {
            const runner = runnersData.find(r => r.objectId === runnerId);
            if (!runner) return;

            const photoPath = runner.photoFilename ? `profiles/${runner.photoFilename}` : 'https://via.placeholder.com/128';

            modalRunnerPhoto.src = photoPath;
            modalRunnerName.textContent = runner.name;
            modalAboutRunnerName.textContent = runner.name;

            modalRunnerRatingStars.innerHTML = generateStarRating(runner.rating || 0);
            modalRunnerRatingValue.textContent = (runner.rating || 0).toFixed(1);
            modalRunnerTasks.textContent = `(${runner.tasksCompleted || 0} tasks completed)`;

            modalRunnerAvailability.textContent = runner.availability || 'Not Specified';
            const availabilityClass = runner.availability === 'Available' ? 'bg-green-50 text-green-700 border border-green-300' : 'bg-red-50 text-red-700 border border-red-300';
            modalRunnerAvailability.className = `text-md font-bold px-4 py-1 rounded-full inline-block mt-2 ${availabilityClass}`;

            modalRunnerLocation.textContent = (runner.location && runner.location.area) || 'Not specified';
            modalRunnerMapLink.href = (runner.location && runner.location.latitude && runner.location.longitude) ? 
                `https://www.google.com/maps/search/?api=1&query=${runner.location.latitude},${runner.location.longitude}` : '#';
            if (modalRunnerMapLink.href === '#') {
                modalRunnerMapLink.classList.add('hidden');
            } else {
                modalRunnerMapLink.classList.remove('hidden');
            }

            modalRunnerBio.textContent = runner.bio || 'This runner has not provided a bio yet.';
            modalRunnerServices.innerHTML = (runner.services || []).map(service => `<span class="bg-light-gold text-maroon text-sm font-medium px-3 py-1 rounded-full shadow-sm">${service}</span>`).join('');

            modalRunnerRate.textContent = runner.hourlyRate || 'Varies by task';
            modalRunnerVehicle.textContent = runner.vehicle || 'Not specified';
            modalRunnerResponseTime.textContent = runner.responseTime || 'N/A';
            modalRunnerLanguages.textContent = (runner.languages || []).join(', ') || 'N/A';

            modalRunnerReviews.innerHTML = '';
            if (runner.reviews && runner.reviews.length > 0) {
                runner.reviews.forEach(review => {
                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                    reviewDiv.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="flex mr-2">${generateStarRating(review.stars)}</div>
                            <span class="font-semibold text-gray-800">${review.reviewer}</span>
                        </div>
                        <p class="text-sm text-gray-700 leading-relaxed">${review.text}</p>
                    `;
                    modalRunnerReviews.appendChild(reviewDiv);
                });
            } else {
                modalRunnerReviews.innerHTML = '<p class="text-gray-500 text-sm italic">No reviews yet. Be the first to review!</p>';
            }

            modalBookNowBtn.onclick = () => {
                alert(`You are about to book ${runner.name} for an errand! (This is a demo action)`);
                closeRunnerModal();
            };

            runnerModal.style.display = 'flex';
            document.body.classList.add('overflow-hidden');
        }

        function closeRunnerModal() {
            runnerModal.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
            modalBookNowBtn.onclick = null;
        }


        // --- Event Listeners ---
        retryLocationButton.addEventListener('click', getBrowserLocation);
        applyFiltersButton.addEventListener('click', () => {
            const selectedValue = locationSelect.value;
            localStorage.setItem('simulatedLocation', selectedValue);

            if (selectedValue === 'auto') {
                getBrowserLocation();
            } else {
                const simulatedLoc = simulatedLocations[selectedValue];
                if (simulatedLoc) {
                    currentUserLocation = simulatedLoc;
                    setStatusMessage('success');
                    applyFiltersAndSort();
                } else {
                    setStatusMessage('error', 'Invalid simulated location selected.');
                }
            }
        });
        
        // Listeners for filter and sort dropdowns to automatically re-render
        locationSelect.addEventListener('change', applyFiltersAndSort);
        serviceFilter.addEventListener('change', applyFiltersAndSort);
        availabilityFilter.addEventListener('change', applyFiltersAndSort);
        sortBy.addEventListener('change', applyFiltersAndSort);


        // Modal close listeners
        closeModalButton.addEventListener('click', closeRunnerModal);
        runnerModal.addEventListener('click', (event) => {
            if (event.target === runnerModal) {
                closeRunnerModal();
            }
        });

        // Mobile menu toggle
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
        });

        // Back to Top button logic
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                backToTopButton.classList.remove('hidden');
            } else {
                backToTopButton.classList.add('hidden');
            }
        });

        backToTopButton.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // --- Initial Page Load ---
        fetchRunnersData();
    });
</script> 
</body>
 </html>
