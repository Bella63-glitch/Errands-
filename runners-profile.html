<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Runner HQ - Profile</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --maroon: #7b1e3a; --gold: #ffd700; --light-bg: #e9eef2; --text-dark: #2c3e50; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; background: var(--light-bg); display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .top-header { width: 100%; background-color: var(--maroon); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; color: white; box-sizing: border-box; }
        .profile-container { background: #fff; border-radius: 20px; width: 95%; max-width: 600px; margin: 40px 0; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .profile-header { background: linear-gradient(135deg, var(--maroon), #5c162b); padding: 40px 20px 60px; position: relative; text-align: center; }
        .profile-pic-wrapper { position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); width: 120px; height: 120px; }
        .profile-pic { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--gold); background: white; object-fit: cover; }
        .stats-bar { display: flex; justify-content: space-around; margin-top: 60px; padding: 20px; border-bottom: 1px solid #eee; }
        .stat-item { text-align: center; }
        .stat-val { display: block; font-weight: 800; color: var(--maroon); font-size: 1.2rem; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }
        .details { padding: 20px; }
        .detail-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .highlight { font-weight: 600; color: var(--text-dark); }
        .btn-main { width: 100%; padding: 15px; background: var(--maroon); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-bottom: 10px; }
        #editmodal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; padding:20px; }
        .modal-box { background:white; padding:25px; border-radius:15px; width:100%; max-width:400px; }
        input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="top-header">
        <span style="font-weight: 800;">RUNNER HQ</span>
        <span id="headername" style="color: var(--gold);">Profile</span>
    </div>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-pic-wrapper">
                <img id="runnerimage" class="profile-pic" src="https://via.placeholder.com/120" alt="Runner">
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item"><span class="stat-val" id="profileviewsdisplay">--</span><span class="stat-label">Views</span></div>
            <div class="stat-item"><span class="stat-val" id="ratingdisplay">--</span><span class="stat-label">Rating</span></div>
            <div class="stat-item"><span class="stat-val" id="badgedisplay">--</span><span class="stat-label">Badge</span></div>
        </div>

        <div class="details">
            <div class="detail-row" onclick="openedit('name', 'Name')"><strong>Name</strong> <span id="runnername" class="highlight">Loading...</span></div>
            <div class="detail-row" onclick="openedit('phone', 'Phone')"><strong>Phone</strong> <span id="runnerphone" class="highlight">Loading...</span></div>
            <div class="detail-row" onclick="openedit('location', 'Location')"><strong>Location</strong> <span id="runnerlocation" class="highlight">Loading...</span></div>
            <div class="detail-row" onclick="openedit('about', 'About')"><strong>About</strong> <span id="runnerabout" class="highlight">Loading...</span></div>
        </div>

        <div style="padding: 20px;">
            <button class="btn-main" onclick="shareprofile()">Share Profile Link</button>
            <button onclick="logout()" style="width:100%; background:none; border:none; color:red; cursor:pointer; font-weight:600;">Logout</button>
        </div>
    </div>

    <div id="editmodal">
        <div class="modal-box">
            <h3 id="modaltitle">Edit</h3>
            <input type="text" id="editinput">
            <button class="btn-main" id="savebtn">Save</button>
            <button onclick="closeModal()" style="width:100%; border:none; background:none; color:#666;">Cancel</button>
        </div>
    </div>

    <script>
        // 2. Setup Database Connection Carefully
        const SB_URL = "https://zchofpncqskvnfrzbcww.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjaG9mcG5jcXNrdm5mcnpiY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDI4NDIsImV4cCI6MjA3NTUxODg0Mn0.U-Zm4slsBcWHSpfhjM8jvBvtt8YCPMAiSopWR9-YXUI";
        
        // Prevent duplicate client creation
        if (!window.supabaseClient) {
            window.supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        }

        async function fetchProfile() {
            let email = localStorage.getItem("loggedInEmail");

            if (!email) {
                email = prompt("Enter email to load profile:");
                if (email) localStorage.setItem("loggedInEmail", email.trim().toLowerCase());
                else return;
            }

            try {
                const { data, error } = await window.supabaseClient
                    .from('runners')
                    .select('*')
                    .eq('email', email.trim().toLowerCase())
                    .maybeSingle();

                if (error) throw error;

                if (data) {
                    document.getElementById("runnername").innerText = data.name || "None";
                    document.getElementById("headername").innerText = data.name || "Runner";
                    document.getElementById("runnerphone").innerText = data.phone || "None";
                    document.getElementById("runnerlocation").innerText = data.location || "None";
                    document.getElementById("runnerabout").innerText = data.about || "None";
                    if(data.profilepicture) document.getElementById("runnerimage").src = data.profilepicture;

                    document.getElementById("profileviewsdisplay").innerText = "12";
                    document.getElementById("ratingdisplay").innerText = "4.9";
                    document.getElementById("badgedisplay").innerText = "Verified";
                } else {
                    alert("Profile not found in database.");
                }
            } catch (err) {
                console.error("Fetch failed:", err);
                // If the signal was aborted, try one more time automatically
                if (err.name === 'AbortError') {
                    console.log("Retrying once...");
                    fetchProfile();
                } else {
                    alert("Network error. Please check your data connection.");
                }
            }
        }

        function openedit(col, label) {
            document.getElementById("editmodal").style.display = "flex";
            document.getElementById("modaltitle").innerText = "Edit " + label;
            const btn = document.getElementById("savebtn");
            btn.onclick = async () => {
                const email = localStorage.getItem("loggedInEmail");
                const val = document.getElementById("editinput").value;
                const { error } = await window.supabaseClient.from('runners').update({ [col]: val }).eq('email', email);
                if (!error) location.reload();
                else alert("Update failed: " + error.message);
            }
        }

        function closeModal() { document.getElementById("editmodal").style.display = "none"; }
        function logout() { localStorage.clear(); location.reload(); }
        function shareprofile() { window.open(`https://wa.me/?text=My Profile: ${window.location.href}`); }

        // Start when ready
        window.addEventListener('load', fetchProfile);
    </script>
</body>
</html>





