<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - Run Me An Errand</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root { --maroon: #7B1E3A; --gold: #FFD700; }
  body { font-family: sans-serif; background-color: #f3f3f3; margin:0; min-height:100vh; display:flex; justify-content:center; align-items:flex-start; padding-top:50px; }
  .profile-card { background:#fff; border-radius:1rem; padding:2rem; box-shadow:0 4px 6px rgba(0,0,0,0.1); max-width:800px; width:100%; }
  .spinner { border:4px solid #f3f3f3; border-top:4px solid var(--maroon); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:4rem auto; }
  @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
  .text-maroon { color: var(--maroon); }
  .text-gold { color: var(--gold); }
  button { font-weight:bold; padding:0.75rem 1.5rem; border-radius:8px; cursor:pointer; transition:all 0.3s; margin-right:0.5rem; }
  .btn-primary { background-color: var(--maroon); color: var(--gold); }
  .btn-primary:hover { background-color: var(--gold); color: var(--maroon); }
  .btn-secondary { background-color:#e5e7eb; color:#4b5563; }
  .btn-secondary:hover { background-color:#d1d5db; }
  input { width:100%; padding:0.6rem; margin-top:0.3rem; border:1px solid #ccc; border-radius:6px; }
</style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <p class="text-maroon" style="text-align:center;">Loading your profile...</p>
</div>

<div id="profileContent" class="profile-card" style="display:none;"></div>
<div id="errorMessage" class="text-maroon" style="text-align:center; display:none;"></div>

<script>
  const SUPABASE_URL = 'https://zchofpncqskvnfrzbcww.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjaG9mcG5jcXNrdm5mcnpiY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDI4NDIsImV4cCI6MjA3NTUxODg0Mn0.U-Zm4slsBcWHSpfhjM8jvBvtt8YCPMAkSopWR9-YXUI';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const profileDiv = document.getElementById('profileContent');
  const loadingDiv = document.getElementById('loading');
  const errorDiv = document.getElementById('errorMessage');

  async function loadProfile() {
    const runnerEmail = localStorage.getItem('runner_email');
    const clientEmail = localStorage.getItem('client_email');

    if (!runnerEmail && !clientEmail) {
      redirectToLogin("User session not found. Redirecting to login...");
      return;
    }

    const email = runnerEmail || clientEmail;
    const table = runnerEmail ? 'runners' : 'users';

    try {
      const { data: profile, error } = await supabase
        .from(table)
        .select('*')
        .eq('email', email)
        .single();

      if (error || !profile) throw error || new Error("Profile not found");

      displayProfile(profile, runnerEmail ? true : false);

    } catch (err) {
      console.error("Profile load error:", err);
      loadingDiv.style.display = 'none';
      errorDiv.textContent = 'Failed to load profile. Please login again.';
      errorDiv.style.display = 'block';
      setTimeout(() => window.location.href = 'login.html', 2000);
    }
  }

  function displayProfile(profile, isRunner) {
    loadingDiv.style.display = 'none';
    profileDiv.style.display = 'block';

    profileDiv.innerHTML = `
      <h2 class="text-maroon" style="text-align:center; margin-bottom:1rem;">${profile.full_name || profile.email}</h2>
      <p style="text-align:center; color:#555;">${profile.email}</p>
      ${isRunner ? `<p style="text-align:center; color:#555;">Phone: ${profile.phone || 'N/A'}</p>` : ''}
      <div style="margin-top:2rem; text-align:center;">
        <button id="editBtn" class="btn-primary">Edit Profile</button>
        <button id="logoutBtn" class="btn-secondary">Logout</button>
      </div>
    `;

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (isRunner) localStorage.removeItem('runner_email');
      else localStorage.removeItem('client_email');
      window.location.href = 'login.html';
    });

    document.getElementById('editBtn').addEventListener('click', () => enableEdit(profile, isRunner));
  }

  function enableEdit(profile, isRunner) {
    profileDiv.innerHTML = `
      <h2 class="text-maroon" style="text-align:center; margin-bottom:1rem;">Edit Profile</h2>
      <label>Full Name: <input type="text" id="nameInput" value="${profile.full_name || ''}"></label>
      ${isRunner ? `<label>Phone: <input type="text" id="phoneInput" value="${profile.phone || ''}"></label>` : ''}
      <div style="margin-top:1rem; text-align:center;">
        <button id="saveBtn" class="btn-primary">Save</button>
        <button id="cancelBtn" class="btn-secondary">Cancel</button>
      </div>
    `;

    document.getElementById('cancelBtn').addEventListener('click', () => displayProfile(profile, isRunner));

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const updatedFields = { full_name: document.getElementById('nameInput').value.trim() };
      if (isRunner) updatedFields.phone = document.getElementById('phoneInput').value.trim();

      try {
        const { data, error } = await supabase
          .from(isRunner ? 'runners' : 'users')
          .update(updatedFields)
          .eq('email', profile.email)
          .select('*')
          .single();

        if (error) throw error;

        displayProfile(data, isRunner);
      } catch (err) {
        console.error("Update error:", err);
        errorDiv.textContent = "Failed to update profile.";
        errorDiv.style.display = 'block';
        setTimeout(() => errorDiv.style.display = 'none', 3000);
      }
    });
  }

  function redirectToLogin(message) {
    loadingDiv.style.display = 'none';
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => window.location.href = 'login.html', 2000);
  }

  loadProfile();
</script>

</body>
</html>




