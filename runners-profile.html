<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Runner Profile - Run Me An Errand</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --maroon: #7B1E3A;
      --gold: #FFD700;
      --light-bg: #f0f4f8; /* Softer background */
      --text-dark: #333;
      --border-light: #e0e0e0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--light-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 3rem 1rem;
    }

    .profile-container {
      background-color: #fff;
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
      padding: 3rem;
      width: 100%;
      max-width: 600px;
      text-align: center;
      transition: transform 0.3s ease-in-out;
    }

    h2 {
      color: var(--maroon);
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .profile-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 2rem;
    }

    .profile-pic-wrapper {
      position: relative;
      width: 130px;
      height: 130px;
      margin-bottom: 1.5rem;
    }

    .profile-pic {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--gold);
      box-shadow: 0 0 0 3px var(--maroon);
    }

    .details {
      text-align: left;
    }

    .details p, .details .detail-item {
      font-size: 1.05rem;
      padding: 0.8rem 0;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-dark);
    }

    .details p:last-child, .details .detail-item:last-child {
      border-bottom: none;
    }

    .details strong {
      color: var(--maroon);
      font-weight: 600;
      min-width: 100px; /* Aligns labels */
    }

    .highlight {
      font-weight: 500;
      color: var(--text-dark);
      text-align: right;
      flex-grow: 1;
    }

    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      color: white;
      font-weight: bold;
      font-size: 0.85rem;
    }

    .active { background-color: #28a745; } /* Green */
    .inactive { background-color: #dc3545; } /* Red */

    .button-group {
      margin-top: 2rem;
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    button {
      background-color: var(--maroon);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(123, 30, 58, 0.2);
    }

    button:hover {
      background-color: #66182f;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(123, 30, 58, 0.3);
    }

    #editBtn {
      background-color: var(--gold);
      color: var(--maroon);
    }

    #editBtn:hover {
      background-color: #e6c500;
    }

    /* --- Popup/Toast Notification --- */
    .popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 25px;
      border-radius: 8px;
      font-weight: 600;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      animation: fadeInOut 4s ease-in-out forwards;
    }

    .popup.success { background: #28a745; }
    .popup.error { background: #dc3545; }
    .popup.info { background: #17a2b8; }

    /* --- Edit Form Styling (Hidden by default) --- */
    #editForm {
      text-align: left;
      margin-top: 2rem;
      display: none; /* Initially hidden */
    }

    #editForm label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: var(--maroon);
    }

    #editForm input[type="text"],
    #editForm input[type="email"],
    #editForm textarea {
      width: calc(100% - 20px);
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    #editForm textarea {
        resize: vertical;
        min-height: 80px;
    }

    .edit-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 1.5rem;
    }

    .edit-actions button {
        margin: 0;
        padding: 10px 25px;
    }

    #cancelEditBtn {
        background-color: #6c757d;
        color: white;
    }

    #cancelEditBtn:hover {
        background-color: #5a6268;
    }

    #imageUploadLabel {
        display: block;
        width: 100%;
        text-align: center;
        margin-top: 1rem;
        padding: 10px;
        background-color: var(--maroon);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #imageUploadLabel:hover {
        background-color: #66182f;
    }

    #profilePictureInput {
        display: none;
    }

    /* Animation for fadeInOut popup */
    @keyframes fadeInOut {
        0% { opacity: 0; }
        10% { opacity: 1; }
        90% { opacity: 1; }
        100% { opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="popup" class="popup"></div>

  <div class="profile-container">
    <div id="viewMode">
        <div class="profile-header">
            <h2>Runner Profile</h2>
            <div class="profile-pic-wrapper">
                <img id="runnerImage" class="profile-pic" src="https://via.placeholder.com/130/7B1E3A/FFD700?text=R" alt="Profile Picture" />
            </div>
        </div>

        <div class="details" id="runnerDetails">
            <div class="detail-item">
                <strong>Name:</strong> <span id="runnerName" class="highlight">Loading...</span>
            </div>
            <div class="detail-item">
                <strong>Email:</strong> <span id="runnerEmail" class="highlight">Loading...</span>
            </div>
            <div class="detail-item">
                <strong>Phone:</strong> <span id="runnerPhone" class="highlight">Loading...</span>
            </div>
            <div class="detail-item">
                <strong>About:</strong> <span id="runnerAbout" class="highlight">Loading...</span>
            </div>
            <div class="detail-item">
                <strong>Experience:</strong> <span id="runnerExperience" class="highlight">Loading...</span>
            </div>
            <div class="detail-item">
                <strong>Availability:</strong> <span id="runnerAvailability" class="highlight">Loading...</span>
            </div>
            <div class="detail-item">
                <strong>Location:</strong> <span id="runnerLocation" class="highlight">Loading...</span>
            </div>
            <div class="detail-item">
                <strong>Status:</strong> <span id="runnerStatus" class="status-badge">Loading...</span>
            </div>
        </div>

        <div class="button-group">
            <button id="editBtn"><i class="fas fa-edit"></i> Edit Profile</button>
            <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>

    <div id="editMode">
        <form id="editForm">
            <h3>Edit Your Details</h3>

            <label for="profilePictureInput" id="imageUploadLabel">
                <i class="fas fa-camera"></i> Change Profile Picture
            </label>
            <input type="file" id="profilePictureInput" accept="image/*">
            <small>Note: Image will update upon saving.</small>

            <label for="editName">Full Name</label>
            <input type="text" id="editName" required>

            <label for="editPhone">Phone</label>
            <input type="text" id="editPhone">

            <label for="editLocation">Location</label>
            <input type="text" id="editLocation">

            <label for="editAvailability">Availability</label>
            <input type="text" id="editAvailability">

            <label for="editExperience">Experience (e.g., 2 years)</label>
            <input type="text" id="editExperience">

            <label for="editAbout">About Me</label>
            <textarea id="editAbout"></textarea>

            <div class="edit-actions">
                <button type="button" id="cancelEditBtn">Cancel</button>
                <button type="submit" id="saveBtn"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </form>
    </div>
  </div>

  <script>
    // Supabase Configuration
    const supabaseUrl = "https://zchofpncqskvnfrzbcww.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjaG9mcG5jcXNrdm5mcnpiY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDI4NDIsImV4cCI6MjA3NTUxODg0Mn0.U-Zm4slsBcWHSpfhjM8jvBvtt8YCPMAiSopWR9-YXUI";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const BUCKET_NAME = 'profiles'; 

    // DOM Elements
    const popup = document.getElementById("popup");
    const logoutBtn = document.getElementById("logoutBtn");
    const editBtn = document.getElementById("editBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveBtn = document.getElementById("saveBtn");
    const viewMode = document.getElementById("viewMode");
    const editMode = document.getElementById("editMode");
    const editForm = document.getElementById("editForm");
    const profilePictureInput = document.getElementById("profilePictureInput");

    // Current User State
    const email = localStorage.getItem("loggedInEmail");
    const userType = localStorage.getItem("userType");
    let currentRunnerData = null; // Store fetched data

    /**
     * Toggles the view between the profile details and the edit form.
     * @param {boolean} isEditing - True to show the edit form, false to show details.
     */
    function toggleEditMode(isEditing) {
        viewMode.style.display = isEditing ? "none" : "block";
        editMode.style.display = isEditing ? "block" : "none";
    }

    /**
     * Displays a temporary notification popup.
     * @param {string} message - The message to display.
     * @param {string} type - The type of popup ('success', 'error', 'info').
     */
    function showPopup(message, type = "info") {
      popup.textContent = message;
      popup.className = "popup " + type;
      popup.style.display = "block";
      setTimeout(() => (popup.style.display = "none"), 4000);
    }

    /**
     * Authenticates the user session.
     */
    function checkLogin() {
        if (!email || userType !== "runner") {
            alert("Session expired. Please log in again.");
            window.location.href = "login.html";
        }
    }

    /**
     * Loads the runner profile details from Supabase and populates the view mode and edit form.
     */
    async function loadRunnerProfile() {
      checkLogin();

      try {
        const { data, error } = await supabase
          .from("runners")
          .select("*")
          .eq("email", email)
          .maybeSingle();

        if (error || !data) {
          console.error("Profile load error:", error);
          showPopup("❌ Failed to load profile. Please log in again.", "error");
          setTimeout(() => window.location.href = "login.html", 2000);
          return;
        }

        currentRunnerData = data;
        populateViewMode(data);
        populateEditForm(data);

      } catch (err) {
        console.error("Error fetching profile:", err);
        showPopup("❌ Error loading profile", "error");
      }
    }

    /**
     * Populates the read-only view mode with runner data.
     * @param {object} data - The runner profile data.
     */
    function populateViewMode(data) {
        // FIX APPLIED HERE: Use 'name' for the runner's name
        document.getElementById("runnerName").textContent = data.name || "N/A";
        document.getElementById("runnerEmail").textContent = data.email;
        document.getElementById("runnerPhone").textContent = data.phone || "N/A";
        document.getElementById("runnerAbout").textContent = data.about || "N/A";
        document.getElementById("runnerExperience").textContent = data.experience || "N/A";
        document.getElementById("runnerAvailability").textContent = data.availability || "N/A";
        document.getElementById("runnerLocation").textContent = data.location || "N/A";

        const statusSpan = document.getElementById("runnerStatus");
        if (data.subscription_status === "active") {
            statusSpan.textContent = "Active ✅";
            statusSpan.className = "status-badge active";
        } else {
            statusSpan.textContent = "Inactive ❌";
            statusSpan.className = "status-badge inactive";
        }

        const imgEl = document.getElementById("runnerImage");
        // FIX APPLIED HERE: Use 'profilepicture'
        imgEl.src = data.profilepicture || "https://via.placeholder.com/130/7B1E3A/FFD700?text=R";
    }

    /**
     * Populates the edit form fields with runner data.
     * @param {object} data - The runner profile data.
     */
    function populateEditForm(data) {
        // FIX APPLIED HERE: Use 'name' for the runner's name
        document.getElementById("editName").value = data.name || "";
        document.getElementById("editPhone").value = data.phone || "";
        document.getElementById("editLocation").value = data.location || "";
        document.getElementById("editAvailability").value = data.availability || "";
        document.getElementById("editExperience").value = data.experience || "";
        document.getElementById("editAbout").value = data.about || "";
    }

    /**
     * Handles the file upload to Supabase Storage.
     * @param {File} file - The image file to upload.
     * @returns {Promise<string|null>} The public URL of the uploaded image or null on error.
     */
    async function uploadProfilePicture(file) {
        const fileExtension = file.name.split('.').pop();
        const filePath = `${email}/${Date.now()}.${fileExtension}`; 

        try {
            const { error: uploadError } = await supabase.storage
                .from(BUCKET_NAME)
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: true,
                });

            if (uploadError) throw uploadError;

            const { data: publicUrlData } = supabase.storage
                .from(BUCKET_NAME)
                .getPublicUrl(filePath);

            return publicUrlData.publicUrl;

        } catch (error) {
            console.error('Error uploading file:', error);
            showPopup(`❌ File upload failed: ${error.message}`, 'error');
            return null;
        }
    }

    /**
     * Handles the form submission for updating the runner profile.
     * @param {Event} e - The form submit event.
     */
    async function handleUpdateProfile(e) {
        e.preventDefault();
        saveBtn.disabled = true;
        showPopup("Saving changes...", "info");

        // FIX APPLIED HERE: Use 'profilepicture'
        let imageUrl = currentRunnerData.profilepicture; 

        // 1. Handle image upload if a new file is selected
        const file = profilePictureInput.files[0];
        if (file) {
            imageUrl = await uploadProfilePicture(file);
            if (!imageUrl) {
                saveBtn.disabled = false;
                return; 
            }
        }

        // 2. Prepare the update data
        const updatedProfile = {
            // FIX APPLIED HERE: Use 'name' for the runner's name
            name: document.getElementById("editName").value, 
            phone: document.getElementById("editPhone").value,
            location: document.getElementById("editLocation").value,
            availability: document.getElementById("editAvailability").value,
            experience: document.getElementById("editExperience").value,
            about: document.getElementById("editAbout").value,
            // FIX APPLIED HERE: Use 'profilepicture'
            profilepicture: imageUrl, 
        };

        // 3. Update the database record
        try {
            const { error: updateError } = await supabase
                .from('runners')
                .update(updatedProfile)
                .eq('email', email);

            if (updateError) throw updateError;

            showPopup("✅ Profile updated successfully!", "success");
            await loadRunnerProfile();
            toggleEditMode(false); 

        } catch (error) {
            console.error("Update error:", error);
            showPopup(`❌ Failed to save profile: ${error.message}`, "error");
        } finally {
            saveBtn.disabled = false;
        }
    }

    // --- Event Listeners ---

    editBtn.addEventListener("click", () => {
        populateEditForm(currentRunnerData); 
        toggleEditMode(true);
    });

    cancelEditBtn.addEventListener("click", () => {
        toggleEditMode(false);
    });

    editForm.addEventListener("submit", handleUpdateProfile);

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("loggedInEmail");
      localStorage.removeItem("userType");
      showPopup("Logging out...", "info");
      setTimeout(() => window.location.href = "login.html", 1000);
    });

    loadRunnerProfile();

  </script>
</body>
              </html>
  
