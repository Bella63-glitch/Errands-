<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Runner Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --maroon: #7B1E3A; --gold: #FFD700; }
.bg-maroon { background-color: var(--maroon); }
.text-maroon { color: var(--maroon); }
.text-gold { color: var(--gold); }
.bg-gold { background-color: var(--gold); }
.bg-maroon-dark { background-color: #66182f; }
.profile-card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; }
.menu { display: none; }
.menu.active { display: block; }
.hamburger { cursor: pointer; font-size: 1.5rem; }
.custom-btn { font-weight: bold; padding: 0.75rem 2rem; border-radius: 9999px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.05em; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.custom-btn-primary { background-color: var(--maroon); color: var(--gold); }
.custom-btn-primary:hover { background-color: var(--gold); color: var(--maroon); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
.custom-btn-secondary { background-color: #e5e7eb; color: #4b5563; }
.custom-btn-secondary:hover { background-color: #d1d5db; }
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--maroon);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 4rem auto;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen flex flex-col">

<header class="bg-maroon shadow-lg sticky top-0 z-50">
<div class="max-w-7xl mx-auto flex justify-between items-center py-5 px-6">
    <a href="index.html" class="flex items-center space-x-2">
        <img src="https://i.postimg.cc/d1z9KLkL/ei-1752053865516-removebg-preview.png" alt="Logo" class="h-16 w-auto">
        <h1 class="text-2xl font-bold text-white">Run Me An Errand</h1>
    </a>
    <i class="fas fa-bars text-white hamburger" id="hamburgerBtn"></i>
</div>
<div id="menu" class="menu bg-maroon text-white flex flex-col px-6 py-4 space-y-3">
    <a href="index.html" class="hover:text-gold">Home</a>
    <button id="logoutBtn" class="bg-gold text-maroon font-bold py-1 px-4 rounded hover:bg-maroon hover:text-gold">Logout</button>
</div>
</header>

<main class="flex-grow flex justify-center items-start p-4 mt-4">
    <div id="loading" class="text-center mt-12">
        <div class="spinner"></div>
        <p class="text-maroon text-xl font-bold">Loading your profile...</p>
    </div>

    <div id="profileContent" class="profile-card w-full max-w-4xl my-8 hidden">
      </div>

    <div id="errorMessage" class="text-center text-red-500 text-xl font-bold hidden mt-12">
        Runner profile not found. Please login again.
    </div>
</main>

<script>
    // 1. Supabase Initialization - Using your provided keys
    const SUPABASE_URL = 'https://zchofpncqskvnfrzbcww.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjaG9mcG5jcXNrdm5mcnpiY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDI4NDIsImV4cCI6MjA3NTUxODg0Mn0.U-Zm4slsBcWHSpfhjM8jvBvtt8YCPMAkSopWR9-YXUI';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM Elements
    const loadingEl = document.getElementById('loading');
    const profileContentEl = document.getElementById('profileContent');
    const errorMessageEl = document.getElementById('errorMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const menuEl = document.getElementById('menu');
    
    // --- KEY DATABASE/SESSION SPECIFICATIONS ---
    const RUNNER_EMAIL_KEY = 'runner_email'; 
    const RUNNER_TABLE = 'runners'; // Your specified table
    const PHONE_COLUMN = 'phone_number'; // Assuming the phone column is named phone_number
    // --- ---

    // ----------------------------------------------------
    // Utility Functions
    // ----------------------------------------------------

    /** Toggles the mobile menu */
    if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', () => {
            menuEl.classList.toggle('active');
        });
    }

    /** Handles user logout and redirects to home/login */
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            localStorage.removeItem(RUNNER_EMAIL_KEY); 
            await supabase.auth.signOut(); // Clear auth session just in case
            window.location.href = 'index.html'; 
        });
    }
    
    /** Redirects to login if session is missing */
    function redirectToLogin(message) {
        if (loadingEl) loadingEl.classList.add('hidden');
        if (errorMessageEl) {
             errorMessageEl.innerText = message;
             errorMessageEl.classList.remove('hidden');
        }
        setTimeout(() => window.location.href = 'index.html', 1500);
    }

    /** Creates the HTML structure for the runner profile display */
    function createProfileCard(profile) {
        const avatarUrl = profile.avatar_url || 'https://via.placeholder.com/150/7B1E3A/FFD700?text=R';

        return `
            <div class="flex flex-col md:flex-row gap-8">
                <div class="md:w-1/3 flex flex-col items-center text-center">
                    <img src="${avatarUrl}" alt="${profile.full_name}'s Avatar" class="w-40 h-40 rounded-full object-cover border-4 border-gold mb-4 shadow-lg">
                    <h2 class="text-3xl font-extrabold text-maroon">${profile.full_name || 'Runner'}</h2>
                    <p class="text-xl text-gray-600 mb-2">${profile.city || 'Set Location'}, ${profile.country || 'Set Country'}</p>
                    <p class="text-gold text-2xl mb-4">
                        <i class="fas fa-running"></i> Your Dashboard
                    </p>
                    <button id="editProfileBtn" class="custom-btn custom-btn-primary w-full max-w-xs mt-4">Edit Profile</button>
                </div>

                <div class="md:w-2/3">
                    <h3 class="text-2xl font-bold text-maroon border-b-2 border-gold pb-2 mb-4">Performance & Stats</h3>
                    <div class="grid grid-cols-2 gap-4 text-lg">
                        <div class="flex flex-col p-3 bg-gray-50 rounded-lg">
                            <span class="font-semibold text-gray-500">Total Deliveries</span>
                            <span class="text-maroon text-2xl font-bold">${profile.total_deliveries || 0}</span> 
                        </div>
                        <div class="flex flex-col p-3 bg-gray-50 rounded-lg">
                            <span class="font-semibold text-gray-500">Average Rating</span>
                            <span class="text-maroon text-2xl font-bold">${profile.average_rating ? profile.average_rating.toFixed(1) : 'N/A'} <i class="fas fa-star text-gold"></i></span>
                        </div>
                        <div class="flex flex-col p-3 bg-gray-50 rounded-lg col-span-2">
                            <span class="font-semibold text-gray-500">Bio</span>
                            <p class="text-gray-700 mt-1 italic">"${profile.bio || 'Tell clients about yourself!'}"</p>
                        </div>
                        
                    </div>
                    
                    <h3 class="text-2xl font-bold text-maroon border-b-2 border-gold pb-2 mt-8 mb-4">Account Details</h3>
                    <p class="text-lg mb-2"><i class="fas fa-envelope text-maroon w-6"></i> ${profile.email || 'N/A'}</p>
                    <p class="text-lg mb-2"><i class="fas fa-phone text-maroon w-6"></i> ${profile[PHONE_COLUMN] || 'Not Set'}</p>
                </div>
            </div>
        `;
    }

    /** Switches the content to the edit form */
    function enableEdit(profile) {
        profileContentEl.innerHTML = `
            <div class="flex flex-col space-y-4">
                <h3 class="text-2xl font-bold text-maroon border-b-2 border-gold pb-2 mb-4">Edit Profile</h3>
                <label class="block">
                    <span class="text-lg font-semibold text-maroon">Full Name:</span>
                    <input type="text" id="nameInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-maroon focus:ring focus:ring-maroon focus:ring-opacity-50 p-2" value="${profile.full_name || ''}">
                </label>
                <label class="block">
                    <span class="text-lg font-semibold text-maroon">Phone:</span>
                    <input type="text" id="phoneInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-maroon focus:ring focus:ring-maroon focus:ring-opacity-50 p-2" value="${profile[PHONE_COLUMN] || ''}">
                </label>
                <label class="block">
                    <span class="text-lg font-semibold text-maroon">City:</span>
                    <input type="text" id="cityInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-maroon focus:ring focus:ring-maroon focus:ring-opacity-50 p-2" value="${profile.city || ''}">
                </label>
                <label class="block">
                    <span class="text-lg font-semibold text-maroon">Country:</span>
                    <input type="text" id="countryInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-maroon focus:ring focus:ring-maroon focus:ring-opacity-50 p-2" value="${profile.country || ''}">
                </label>
                <label class="block">
                    <span class="text-lg font-semibold text-maroon">Bio:</span>
                    <textarea id="bioInput" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-maroon focus:ring focus:ring-maroon focus:ring-opacity-50 p-2">${profile.bio || ''}</textarea>
                </label>
                <div class="mt-6 flex space-x-4">
                    <button id="saveBtn" class="custom-btn custom-btn-primary">Save Changes</button>
                    <button id="cancelBtn" class="custom-btn custom-btn-secondary">Cancel</button>
                </div>
            </div>
        `;
        
        // Add event listeners for the edit form buttons
        document.getElementById('cancelBtn').addEventListener('click', () => displayProfile(profile));
        document.getElementById('saveBtn').addEventListener('click', () => handleSave(profile));
    }

    /** Handles saving the updated profile data */
    async function handleSave(originalProfile) {
        errorMessageEl.classList.add('hidden');
        
        const updatedFields = {
            full_name: document.getElementById('nameInput').value.trim(),
            [PHONE_COLUMN]: document.getElementById('phoneInput').value.trim(),
            city: document.getElementById('cityInput').value.trim(),
            country: document.getElementById('countryInput').value.trim(),
            bio: document.getElementById('bioInput').value.trim(),
        };

        if (!updatedFields.full_name) {
            errorMessageEl.innerText = "Full Name cannot be empty.";
            errorMessageEl.classList.remove('hidden');
            return;
        }

        try {
            // Update the record in the 'runners' table using the profile's email
            const { data: updatedData, error } = await supabase
                .from(RUNNER_TABLE)
                .update(updatedFields)
                .eq('email', originalProfile.email) // Match by runner's email
                .select('*')
                .single();

            if (error) throw error;

            // Redisplay the profile with the newly saved data
            displayProfile(updatedData);
            
            // Show success message
            errorMessageEl.innerText = "Profile updated successfully! ✅";
            errorMessageEl.classList.remove('hidden');
            setTimeout(() => errorMessageEl.classList.add('hidden'), 3000);

        } catch (err) {
            console.error("Profile update error:", err);
            errorMessageEl.innerText = `Failed to update profile: ${err.message}`;
            errorMessageEl.classList.remove('hidden');
        }
    }

    /** Binds the profile data to the display template and adds the edit button listener */
    function displayProfile(profile) {
        // Populate and display profile
        profileContentEl.innerHTML = createProfileCard(profile);
        
        // Hide loading, show content
        if (loadingEl) loadingEl.classList.add('hidden');
        if (profileContentEl) profileContentEl.classList.remove('hidden');
        
        // Attach listener for the 'Edit Profile' button
        const editBtn = document.getElementById('editProfileBtn');
        if(editBtn) editBtn.addEventListener('click', () => enableEdit(profile));
    }


    // ----------------------------------------------------
    // Main Profile Loading Logic
    // ----------------------------------------------------

    async function loadRunnerProfile() {
        // 1. Check for the runner's custom session (email in localStorage)
        const runnerEmail = localStorage.getItem(RUNNER_EMAIL_KEY);

        if (!runnerEmail) {
            redirectToLogin("Runner session expired. Please log in.");
            return;
        }
        
        // Show loading state
        if (profileContentEl) profileContentEl.classList.add('hidden');
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (errorMessageEl) errorMessageEl.classList.add('hidden');

        try {
            // 2. Fetch runner data from the 'runners' table using the email
            const { data: profile, error } = await supabase
                .from(RUNNER_TABLE)
                .select('*') 
                .eq('email', runnerEmail) // Query the 'runners' table using the email from localStorage
                .single();

            if (error && error.code !== 'PGRST116') { 
                throw error;
            }

            // 3. Check if profile data was found
            if (!profile) {
                console.warn(`Profile data missing in ${RUNNER_TABLE} for email:`, runnerEmail);
                if (loadingEl) loadingEl.classList.add('hidden');
                if (errorMessageEl) {
                    errorMessageEl.innerText = 'Profile not found. Please contact support.';
                    errorMessageEl.classList.remove('hidden');
                }
                return;
            }

            // 4. Display the profile
            displayProfile(profile);

        } catch (error) {
            console.error('Failed to load dashboard:', error.message);
            if (loadingEl) loadingEl.classList.add('hidden');
            if (errorMessageEl) {
                errorMessageEl.innerText = 'Could not load your dashboard due to a network or database error.';
                errorMessageEl.classList.remove('hidden');
            }
        }
    }

    // Run the main function when the page loads
    document.addEventListener('DOMContentLoaded', loadRunnerProfile);
</script>
</body>
</html>









